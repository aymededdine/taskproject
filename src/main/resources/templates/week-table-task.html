<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<title>Task List</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
		integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
	<link th:href="@{/css-folder/week-table-task-css.css}" rel="stylesheet" />
	<meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />



</head>

<body>
	<div th:replace="header :: header"></div>


	<form id="selectDays" class="container mt-4" th:if="${weekTable.submitted == true or tableIsNull == true}">
		<fieldset>
			<legend>Please add tasks to the days you'd like to schedule, avoiding your busy or break days</legend>
			<div class="days-grid">
				<!-- Monday -->
				<div class="day-card">
					<label class="form-check-label" for="monday">Monday</label>
					<div id="MONDAYTasks" class="mt-2"></div>
					<button type="button" class="btn btn-success add-task-button" onclick="addTask('MONDAY')">Add
						Task</button>
					<br />
					<br />
					<span id="copyfromMONDAY" class="hidden-span">
						<a href="javascript:void(0)" onclick="copyTo('MONDAY')">Copy tasks to</a>
						<select id="MONDAYSelect">
							<option value="TUESDAY">TUESDAY</option>
							<option value="WEDNESDAY">WEDNESDAY</option>
							<option value="THURSDAY">THURSDAY</option>
							<option value="FRIDAY">FRIDAY</option>
							<option value="SATURDAY">SATURDAY</option>
							<option value="SUNDAY">SUNDAY</option>
						</select>
					</span>
				</div>

				<!-- Tuesday -->
				<div class="day-card">
					<label class="form-check-label" for="tuesday">Tuesday</label>
					<div id="TUESDAYTasks" class="mt-2"></div>
					<button type="button" class="btn btn-success add-task-button" onclick="addTask('TUESDAY')">Add
						Task</button>
					<br />
					<br />
					<span id="copyfromTUESDAY" class="hidden-span">
						<a href="javascript:void(0)" onclick="copyTo('TUESDAY')">Copy tasks to</a>
						<select id="TUESDAYSelect">
							<option value="MONDAY">MONDAY</option>
							<option value="WEDNESDAY">WEDNESDAY</option>
							<option value="THURSDAY">THURSDAY</option>
							<option value="FRIDAY">FRIDAY</option>
							<option value="SATURDAY">SATURDAY</option>
							<option value="SUNDAY">SUNDAY</option>
						</select>
					</span>
				</div>


				<!-- Wednesday -->
				<div class="day-card">
					<label class="form-check-label" for="wednesday">Wednesday</label>
					<div id="WEDNESDAYTasks" class="mt-2"></div>
					<button type="button" class="btn btn-success add-task-button" onclick="addTask('WEDNESDAY')">Add
						Task</button>
					<br />
					<br />
					<span id="copyfromWEDNESDAY" class="hidden-span">
						<a href="javascript:void(0)" onclick="copyTo('WEDNESDAY')">Copy tasks to</a>
						<select id="WEDNESDAYSelect">
							<option value="MONDAY">MONDAY</option>
							<option value="TUESDAY">TUESDAY</option>
							<option value="THURSDAY">THURSDAY</option>
							<option value="FRIDAY">FRIDAY</option>
							<option value="SATURDAY">SATURDAY</option>
							<option value="SUNDAY">SUNDAY</option>
						</select>
					</span>
				</div>

				<!-- Thursday -->
				<div class="day-card">
					<label class="form-check-label" for="thursday">Thursday</label>
					<div id="THURSDAYTasks" class="mt-2"></div>
					<button type="button" class="btn btn-success add-task-button" onclick="addTask('THURSDAY')">Add
						Task</button>
					<br />
					<br />
					<span id="copyfromTHURSDAY" class="hidden-span">
						<a href="javascript:void(0)" onclick="copyTo('THURSDAY')">Copy tasks to</a>
						<select id="THURSDAYSelect">
							<option value="MONDAY">MONDAY</option>
							<option value="TUESDAY">TUESDAY</option>
							<option value="WEDNESDAY">WEDNESDAY</option>
							<option value="FRIDAY">FRIDAY</option>
							<option value="SATURDAY">SATURDAY</option>
							<option value="SUNDAY">SUNDAY</option>
						</select>
					</span>
				</div>

				<!-- Friday -->
				<div class="day-card">
					<label class="form-check-label" for="friday">Friday</label>
					<div id="FRIDAYTasks" class="mt-2"></div>
					<button type="button" class="btn btn-success add-task-button" onclick="addTask('FRIDAY')">Add
						Task</button>
					<br />
					<br />
					<span id="copyfromFRIDAY" class="hidden-span">
						<a href="javascript:void(0)" onclick="copyTo('FRIDAY')">Copy tasks to</a>
						<select id="FRIDAYSelect">
							<option value="MONDAY">MONDAY</option>
							<option value="TUESDAY">TUESDAY</option>
							<option value="WEDNESDAY">WEDNESDAY</option>
							<option value="THURSDAY">THURSDAY</option>
							<option value="SATURDAY">SATURDAY</option>
							<option value="SUNDAY">SUNDAY</option>
						</select>
					</span>
				</div>

				<!-- Saturday -->
				<div class="day-card">
					<label class="form-check-label" for="saturday">Saturday</label>
					<div id="SATURDAYTasks" class="mt-2"></div>
					<button type="button" class="btn btn-success add-task-button" onclick="addTask('SATURDAY')">Add
						Task</button>
					<br />
					<br />
					<span id="copyfromSATURDAY" class="hidden-span">
						<a href="javascript:void(0)" onclick="copyTo('SATURDAY')">Copy tasks to</a>
						<select id="SATURDAYSelect">
							<option value="MONDAY">MONDAY</option>
							<option value="TUESDAY">TUESDAY</option>
							<option value="WEDNESDAY">WEDNESDAY</option>
							<option value="THURSDAY">THURSDAY</option>
							<option value="FRIDAY">FRIDAY</option>
							<option value="SUNDAY">SUNDAY</option>
						</select>
					</span>
				</div>

				<!-- Sunday -->
				<div class="day-card">
					<label class="form-check-label" for="sunday">Sunday</label>
					<div id="SUNDAYTasks" class="mt-2"></div>
					<button type="button" class="btn btn-success add-task-button" onclick="addTask('SUNDAY')">Add
						Task</button>
					<br />
					<br />
					<span id="copyfromSUNDAY" class="hidden-span">
						<a href="javascript:void(0)" onclick="copyTo('SUNDAY')">Copy tasks to</a>
						<select id="SUNDAYSelect">
							<option value="MONDAY">MONDAY</option>
							<option value="TUESDAY">TUESDAY</option>
							<option value="WEDNESDAY">WEDNESDAY</option>
							<option value="THURSDAY">THURSDAY</option>
							<option value="FRIDAY">FRIDAY</option>
							<option value="SATURDAY">SATURDAY</option>
						</select>
					</span>
				</div>
			</div>
		</fieldset>
		<br />
		<button type="button" class="btn btn-primary" th:onclick="saveTasks()">Submit</button>
		<button type="button" class="btn btn-secondary" th:onclick="reloadPage()">reset</button>
	</form>

	<br />
	<br />

	<div class="container" th:if="${weekTable.submitted==false and tableIsNull == false}">
		<div class="row">
			<div class="col-md-6 offset-md-3">
				<div class="card text-center">
					<div class="card-body">
						<h1 class="card-title">Warning</h1>
						<p class="card-text">You must complete your last weekly planner before creating a new one.
						</p>
						<p class="card-text">Completion can be achieved by either submitting or withdrawing tasks.</p>

						<a th:href="@{/weekly-tasks/current}" class="btn btn-primary">Back to your current weekly
							planner</a>

					</div>
				</div>
			</div>
		</div>
	</div>

	<script th:inline="javascript">


		function content() {
			return "";
		}



		var springTasks = [[${map}]];



		var tasksByDay = {
			MONDAY: [],
			TUESDAY: [],
			WEDNESDAY: [],
			THURSDAY: [],
			FRIDAY: [],
			SATURDAY: [],
			SUNDAY: [],
		};


		if (springTasks != null) {
			for (const key in springTasks) {
				tasksByDay[key] = springTasks[key];
			}
			console.log(tasksByDay);
			appendBased();
		}

		function copyTo(referencedDay) {

			var selectElement = document.getElementById(referencedDay + "Select");
			var selectedOption = selectElement.options[selectElement.selectedIndex];
			var selectedDay = selectedOption.value;

			console.log(selectedDay);

			tasksByDay[selectedDay] = tasksByDay[referencedDay];

			var dayTasksElement = document.getElementById(selectedDay + "Tasks");
			dayTasksElement.innerHTML = "";

			for (const task of tasksByDay[selectedDay]) {
				let content = `
          			 <div class="task-item" style="display: flex; justify-content: space-between; align-items: center;">
    					<span>${task}</span>
    					<button id="updateButton" style="margin-left: auto;" onclick="updateTask('${selectedDay}', '${task}')">Update</button>
    					<button id="deleteButton" style="margin-left: 10px;" onclick="deleteTask('${selectedDay}', '${task}')">Delete</button>
					</div>

        `;
				dayTasksElement.innerHTML += content;
			}
			attachDeleteButtonListeners(selectedDay);
			var hiddenSpan = document.getElementById("copyfrom" + selectedDay);
			hiddenSpan.style.display = "block";
			updateTaskList();
		}












		function appendBased() {


			for (const key in tasksByDay) {

				if (tasksByDay[key].length === 0) {continue;}

				var dayTasksElement = document.getElementById(key + "Tasks");
				dayTasksElement.innerHTML = "";

				for (const task of tasksByDay[key]) {
					let content = `
          			 <div class="task-item" style="display: flex; justify-content: space-between; align-items: center;">
    					<span>${task}</span>
    					<button id="updateButton" style="margin-left: auto;" onclick="updateTask('${day}', '${task}')">Update</button>
    					<button id="deleteButton" style="margin-left: 10px;" onclick="deleteTask('${day}', '${task}')">Delete</button>
					</div>

        `;
					dayTasksElement.innerHTML += content;
				}
				attachDeleteButtonListeners(key);
			}



		}



		function addTask(day) {
			var taskName = prompt("Enter your task name:");

			if (taskName) {
				if (!tasksByDay[day].includes(taskName)) {
					tasksByDay[day].push(taskName);

					var hiddenSpan = document.getElementById("copyfrom" + day);
					hiddenSpan.style.display = "block";



				} else {
					alert("Task already exists");
				}
			}

			var dayTasksElement = document.getElementById(day + "Tasks");
			dayTasksElement.innerHTML = "";

			for (const task of tasksByDay[day]) {
				let content = `
          			<div class="task-item" style="display: flex; justify-content: space-between; align-items: center;">
    					<span>${task}</span>
    					<button id="updateButton" style="margin-left: auto;" onclick="updateTask('${day}', '${task}')">Update</button>
    					<button id="deleteButton" style="margin-left: 10px;" onclick="deleteTask('${day}', '${task}')">Delete</button>
					</div>`;
				dayTasksElement.innerHTML += content;
			}

			attachDeleteButtonListeners(day);

		}


		function deleteTask(day, taskName) {
			tasksByDay[day] = tasksByDay[day].filter(task => task !== taskName);
			updateTaskList(day);
		}

		function updateTask(day, task) {
			var updatedTask = prompt("Enter your new task name");

			if (updatedTask) {
				if (tasksByDay[day].includes(updatedTask)) {
					alert("Task already exists");
				} else {
					var index = tasksByDay[day].indexOf(task);

					if (index !== -1) {
						tasksByDay[day][index] = updatedTask;
						updateTaskList(day);
					} else {
						alert("Task not found");
					}
				}
			}
		}



		function updateTaskList(day) {
			var dayTasksElement = document.getElementById(day + "Tasks");
			dayTasksElement.innerHTML = "";

			for (const task of tasksByDay[day]) {
				let content = `
                    <div class="task-item" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>${task}</span>
                        <button id="updateButton" style="margin-left: auto;" onclick="updateTask('${day}', '${task}')">Update</button>
                        <button id="deleteButton" style="margin-left: 10px;" onclick="deleteTask('${day}', '${task}')">Delete</button>
                    </div>
                `;
				dayTasksElement.innerHTML += content;
			}

			attachDeleteButtonListeners(day);

		}

		function attachDeleteButtonListeners(day) {
			var deleteButtons = document.querySelectorAll(`#${day}Tasks button`);
			deleteButtons.forEach(button => {
				button.addEventListener("click", function () {
					var taskName = this.parentNode.querySelector("span").textContent;
					deleteTask(day, taskName);
				});
			});
		}


		const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
		const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
		
		function saveTasks() {

			var result = window.confirm("Make sure that you are certain to complete these tasks. Every task you write will be recorded in the statistics and cannot be deleted");

			if (result) {

				var notNullDays = {};
				var blank = true;
				for (var day in tasksByDay) {
					if (tasksByDay[day].length > 0) {
						notNullDays[day] = tasksByDay[day]
						blank = false;
					}
				}

				if (blank == true) {
					alert("you have to add at least one task");
				} else {
					console.log(notNullDays);
					var tasksJSON = JSON.stringify(notNullDays);

					fetch('/weekly-tasks/save-tasks', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							[csrfHeader]: csrfToken
						},
						body: tasksJSON,
					})
						.then(response => {
							if (response.ok) {
								console.log('Tasks saved successfuly');
								window.location.href = '/weekly-tasks/current';
							} else {
								console.error('Error saving tasks')
							}
						})
						.catch(error => {
							console.error('Error: ', error);
						})

				}
			} else {
				console.log("correct")
			}
		}

		function createWeek() {
			document.getElementById('selectDays').style.display = 'block';
			document.getElementById('selectDays').scrollIntoView({behavior: 'smooth'});
		}

		function reloadPage() {
			location.href = location.href;
		}
	</script>
</body>

</html>